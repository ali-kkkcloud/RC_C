<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Attendance Tracking - Manage your check-ins, check-outs and view attendance history">
    <meta name="robots" content="noindex, nofollow">
    <title>Attendance - Employee Portal</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“…</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="attendance-page">
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>
    
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-calendar-check"></i>
                <span>Attendance</span>
            </div>
        </div>
        
        <div class="header-center">
            <div class="current-time-display">
                <div class="time-info">
                    <span id="currentTime" class="current-time">--:--:--</span>
                    <span id="currentDate" class="current-date">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="header-right">
            <button class="header-btn notification-btn" onclick="toggleNotifications()" aria-label="Notifications">
                <i class="fas fa-bell"></i>
                <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
            </button>
            
            <div class="user-menu">
                <button class="user-avatar" onclick="toggleUserMenu()" aria-label="User menu" aria-expanded="false">
                    <span class="user-avatar-text">JD</span>
                </button>
                <span class="user-name">John Doe</span>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav" role="navigation" aria-label="Attendance navigation">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="employee-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="attendance.html" class="nav-link active" aria-current="page">
                        <i class="fas fa-calendar-check"></i>
                        <span>Attendance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="tasks.html" class="nav-link">
                        <i class="fas fa-tasks"></i>
                        <span>My Tasks</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="training.html" class="nav-link">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Training</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#profile" class="nav-link" onclick="showProfile()">
                        <i class="fas fa-user-circle"></i>
                        <span>My Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <div class="header-content">
                <h1>Attendance Tracking</h1>
                <p>Monitor your work hours, check in/out, and view your attendance history.</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="exportAttendance()">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
                <button class="btn btn-outline" onclick="generateAttendanceReport()">
                    <i class="fas fa-chart-bar"></i>
                    View Report
                </button>
            </div>
        </section>

        <!-- Attendance Control Panel -->
        <section class="attendance-panel">
            <div class="panel-grid">
                <!-- Today's Attendance Card -->
                <div class="attendance-card main-card">
                    <div class="card-header">
                        <h2>Today's Attendance</h2>
                        <div class="attendance-status-indicator">
                            <span id="attendanceStatus" class="badge badge-danger">
                                <i class="fas fa-circle"></i>
                                Off Shift
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <div class="time-display">
                            <div class="time-item">
                                <div class="time-label">Check In</div>
                                <div class="time-value" id="checkInTime">--:--</div>
                            </div>
                            <div class="time-item">
                                <div class="time-label">Check Out</div>
                                <div class="time-value" id="checkOutTime">--:--</div>
                            </div>
                            <div class="time-item">
                                <div class="time-label">Total Hours</div>
                                <div class="time-value" id="totalHours">0h 0m</div>
                            </div>
                        </div>

                        <!-- Live Timers -->
                        <div class="timer-display" id="timerDisplay" style="display: none;">
                            <div class="timer-item">
                                <div class="timer-label">Shift Time</div>
                                <div class="timer-value" id="shiftTime">00:00:00</div>
                            </div>
                            <div class="timer-item">
                                <div class="timer-label">Working Time</div>
                                <div class="timer-value" id="workingTime">00:00:00</div>
                            </div>
                            <div class="timer-item">
                                <div class="timer-label">Break Time</div>
                                <div class="timer-value" id="breakTime">00:00:00</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="attendance-actions">
                            <button id="checkInBtn" class="btn btn-success btn-lg" onclick="handleCheckIn()">
                                <i class="fas fa-sign-in-alt"></i>
                                Check In
                            </button>
                            <button id="checkOutBtn" class="btn btn-danger btn-lg" onclick="handleCheckOut()" disabled>
                                <i class="fas fa-sign-out-alt"></i>
                                Check Out
                            </button>
                            <button id="breakBtn" class="btn btn-warning btn-lg" onclick="handleBreakToggle()" disabled>
                                <i class="fas fa-pause"></i>
                                Break
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-panel">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="weeklyHours">35.5h</div>
                            <div class="stat-label">This Week</div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="monthlyHours">142h</div>
                            <div class="stat-label">This Month</div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="attendanceRate">92%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="averageBreakTime">45m</div>
                            <div class="stat-label">Avg Break Time</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Attendance Calendar -->
        <section class="attendance-calendar-section">
            <div class="calendar-header">
                <h2>Monthly Calendar</h2>
                <div class="calendar-controls">
                    <select id="monthSelector" onchange="changeCalendarMonth()" class="form-control">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select id="yearSelector" onchange="changeCalendarYear()" class="form-control">
                        <option value="2023">2023</option>
                        <option value="2024" selected>2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
            </div>
            
            <div class="calendar-container">
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-color present"></span>
                        <span>Present</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color absent"></span>
                        <span>Absent</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color half-day"></span>
                        <span>Half Day</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color holiday"></span>
                        <span>Holiday</span>
                    </div>
                </div>
                
                <div class="calendar" id="attendanceCalendar">
                    <div class="calendar-header-row">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div class="calendar-body" id="attendanceCalendarBody">
                        <!-- Calendar days will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Attendance History -->
        <section class="attendance-history-section">
            <div class="history-header">
                <h2>Attendance History</h2>
                <div class="history-filters">
                    <div class="filter-group">
                        <label for="startDate">From:</label>
                        <input type="date" id="startDate" class="form-control" onchange="loadAttendanceHistory()">
                    </div>
                    <div class="filter-group">
                        <label for="endDate">To:</label>
                        <input type="date" id="endDate" class="form-control" onchange="loadAttendanceHistory()">
                    </div>
                    <button class="btn btn-primary" onclick="loadAttendanceHistory()">
                        <i class="fas fa-filter"></i>
                        Filter
                    </button>
                </div>
            </div>
            
            <div class="history-table-container">
                <table class="table" role="table">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Check In</th>
                            <th scope="col">Check Out</th>
                            <th scope="col">Total Hours</th>
                            <th scope="col">Break Time</th>
                            <th scope="col">Status</th>
                            <th scope="col">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceHistoryBody">
                        <!-- History rows will be populated by JavaScript -->
                        <tr>
                            <td colspan="7" class="text-center">Select date range to view history</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- User Menu Dropdown -->
    <div id="userMenuDropdown" class="dropdown-menu" style="display: none;">
        <a href="#" onclick="showProfile()">
            <i class="fas fa-user"></i>
            My Profile
        </a>
        <a href="employee-dashboard.html">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
        </a>
        <a href="settings.html">
            <i class="fas fa-cog"></i>
            Settings
        </a>
        <hr>
        <a href="#" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </a>
    </div>

    <!-- Attendance Report Modal -->
    <div id="attendanceReportModal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="report-title" aria-modal="true">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="report-title">Attendance Report</h3>
                <button class="modal-close" onclick="closeModal('attendanceReportModal')" aria-label="Close attendance report">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="attendanceReportContent">
                    <!-- Report content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('attendanceReportModal')">Close</button>
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download"></i>
                    Export Report
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/attendance.js"></script>
    <script src="js/notifications.js"></script>
    
    <script>
        // Initialize attendance page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check authentication
                await checkAuth();
                
                // Initialize attendance page
                initializeAttendancePage();
                
                // Set default date range (last 30 days)
                setDefaultDateRange();
                
                // Start time updates
                updateCurrentTime();
                
            } catch (error) {
                console.error('Attendance page initialization error:', error);
                showNotification('Failed to initialize attendance page', 'error');
            }
        });

        function initializeAttendancePage() {
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                // Update user display
                const userNameElements = document.querySelectorAll('.user-name');
                const userAvatarElements = document.querySelectorAll('.user-avatar-text');
                
                userNameElements.forEach(element => {
                    element.textContent = userData.name || 'User';
                });
                
                userAvatarElements.forEach(element => {
                    element.textContent = StringUtils.getInitials(userData.name || 'User');
                });
                
                // Set current month/year in selectors
                const now = new Date();
                const monthSelector = document.getElementById('monthSelector');
                const yearSelector = document.getElementById('yearSelector');
                
                if (monthSelector) monthSelector.value = now.getMonth();
                if (yearSelector) yearSelector.value = now.getFullYear();
                
                // Initialize calendar
                initializeCalendar();
                
            } catch (error) {
                console.error('Initialize attendance page error:', error);
            }
        }

        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeElement = document.getElementById('currentTime');
                const dateElement = document.getElementById('currentDate');
                
                if (timeElement) {
                    timeElement.textContent = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                }
                
                if (dateElement) {
                    dateElement.textContent = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
                
                // Schedule next update
                setTimeout(updateCurrentTime, 1000);
                
            } catch (error) {
                console.error('Update current time error:', error);
            }
        }

        function setDefaultDateRange() {
            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                const startInput = document.getElementById('startDate');
                const endInput = document.getElementById('endDate');
                
                if (startInput) startInput.value = DateTimeUtils.formatDate(startDate, 'YYYY-MM-DD');
                if (endInput) endInput.value = DateTimeUtils.formatDate(endDate, 'YYYY-MM-DD');
                
            } catch (error) {
                console.error('Set default date range error:', error);
            }
        }

        function initializeCalendar() {
            try {
                if (window.attendanceManager && typeof window.attendanceManager.renderCalendar === 'function') {
                    const now = new Date();
                    window.attendanceManager.renderCalendar(now.getFullYear(), now.getMonth(), []);
                } else {
                    // Fallback calendar rendering
                    renderBasicCalendar();
                }
            } catch (error) {
                console.error('Initialize calendar error:', error);
            }
        }

        function renderBasicCalendar() {
            try {
                const calendarBody = document.getElementById('attendanceCalendarBody');
                if (!calendarBody) return;

                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                let calendarHTML = '';
                let currentDate = new Date(startDate);

                // Generate 6 weeks of calendar
                for (let week = 0; week < 6; week++) {
                    calendarHTML += '<div class="calendar-week">';
                    
                    for (let day = 0; day < 7; day++) {
                        const isCurrentMonth = currentDate.getMonth() === month;
                        const isToday = DateTimeUtils.isToday(currentDate);
                        
                        let cellClass = 'calendar-day';
                        if (!isCurrentMonth) cellClass += ' other-month';
                        if (isToday) cellClass += ' today';
                        
                        // Mock attendance status for demo
                        if (isCurrentMonth && currentDate <= now && currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                            const random = Math.random();
                            if (random > 0.1) {
                                cellClass += ' present';
                            } else {
                                cellClass += ' absent';
                            }
                        }

                        calendarHTML += `
                            <div class="${cellClass}" data-date="${DateTimeUtils.formatDate(currentDate, 'YYYY-MM-DD')}">
                                <div class="calendar-date">${currentDate.getDate()}</div>
                            </div>
                        `;
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    calendarHTML += '</div>';
                }

                calendarBody.innerHTML = calendarHTML;
                
            } catch (error) {
                console.error('Render basic calendar error:', error);
            }
        }

        function changeCalendarMonth() {
            try {
                const monthSelector = document.getElementById('monthSelector');
                const yearSelector = document.getElementById('yearSelector');
                
                if (monthSelector && yearSelector) {
                    const month = parseInt(monthSelector.value);
                    const year = parseInt(yearSelector.value);
                    
                    if (window.attendanceManager && typeof window.attendanceManager.loadCalendarData === 'function') {
                        window.attendanceManager.loadCalendarData(year, month);
                    } else {
                        renderBasicCalendar();
                    }
                }
            } catch (error) {
                console.error('Change calendar month error:', error);
            }
        }

        function changeCalendarYear() {
            changeCalendarMonth(); // Same logic
        }

        async function loadAttendanceHistory() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showNotification('Please select both start and end dates', 'warning');
                    return;
                }
                
                if (window.attendanceManager && typeof window.attendanceManager.getAttendanceHistory === 'function') {
                    const history = await window.attendanceManager.getAttendanceHistory(startDate, endDate);
                    displayAttendanceHistory(history);
                } else {
                    // Mock data for demo
                    displayAttendanceHistory(generateMockHistory(startDate, endDate));
                }
                
            } catch (error) {
                console.error('Load attendance history error:', error);
                showNotification('Error loading attendance history', 'error');
            }
        }

        function generateMockHistory(startDate, endDate) {
            const history = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                if (date.getDay() !== 0 && date.getDay() !== 6) { // Skip weekends
                    const random = Math.random();
                    if (random > 0.1) { // 90% attendance
                        history.push({
                            date: DateTimeUtils.formatDate(date, 'YYYY-MM-DD'),
                            check_in: '09:00',
                            check_out: '17:30',
                            total_hours: 8.5,
                            break_time: 45,
                            status: 'present',
                            notes: ''
                        });
                    }
                }
            }
            
            return history;
        }

        function displayAttendanceHistory(history) {
            try {
                const tbody = document.getElementById('attendanceHistoryBody');
                if (!tbody) return;
                
                if (history.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                No attendance records found for the selected period
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = history.map(record => `
                    <tr>
                        <td>${DateTimeUtils.formatDate(record.date, 'long')}</td>
                        <td>${record.check_in || '--'}</td>
                        <td>${record.check_out || '--'}</td>
                        <td>${record.total_hours ? `${record.total_hours}h` : '0h'}</td>
                        <td>${record.break_time ? `${record.break_time}m` : '0m'}</td>
                        <td>
                            <span class="badge badge-${record.status === 'present' ? 'success' : record.status === 'absent' ? 'danger' : 'warning'}">
                                ${StringUtils.capitalize(record.status)}
                            </span>
                        </td>
                        <td>${record.notes || '--'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Display attendance history error:', error);
            }
        }

        function handleCheckIn() {
            try {
                if (window.attendanceManager && typeof window.attendanceManager.handleCheckIn === 'function') {
                    window.attendanceManager.handleCheckIn();
                } else {
                    // Mock check-in functionality
                    document.getElementById('checkInTime').textContent = new Date().toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('attendanceStatus').innerHTML = '<i class="fas fa-circle"></i> On Shift';
                    document.getElementById('attendanceStatus').className = 'badge badge-success';
                    document.getElementById('checkInBtn').disabled = true;
                    document.getElementById('checkOutBtn').disabled = false;
                    document.getElementById('breakBtn').disabled = false;
                    showNotification('Successfully checked in!', 'success');
                }
            } catch (error) {
                console.error('Handle check-in error:', error);
                showNotification('Check-in failed', 'error');
            }
        }

        function handleCheckOut() {
            try {
                if (window.attendanceManager && typeof window.attendanceManager.handleCheckOut === 'function') {
                    window.attendanceManager.handleCheckOut();
                } else {
                    // Mock check-out functionality
                    document.getElementById('checkOutTime').textContent = new Date().toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('attendanceStatus').innerHTML = '<i class="fas fa-circle"></i> Off Shift';
                    document.getElementById('attendanceStatus').className = 'badge badge-danger';
                    document.getElementById('checkInBtn').disabled = false;
                    document.getElementById('checkOutBtn').disabled = true;
                    document.getElementById('breakBtn').disabled = true;
                    showNotification('Successfully checked out!', 'success');
                }
            } catch (error) {
                console.error('Handle check-out error:', error);
                showNotification('Check-out failed', 'error');
            }
        }

        function handleBreakToggle() {
            try {
                if (window.attendanceManager && typeof window.attendanceManager.handleBreakToggle === 'function') {
                    window.attendanceManager.handleBreakToggle();
                } else {
                    // Mock break functionality
                    const breakBtn = document.getElementById('breakBtn');
                    const statusElement = document.getElementById('attendanceStatus');
                    
                    if (breakBtn.textContent.includes('Break')) {
                        breakBtn.innerHTML = '<i class="fas fa-play"></i> End Break';
                        statusElement.innerHTML = '<i class="fas fa-pause-circle"></i> On Break';
                        statusElement.className = 'badge badge-warning';
                        showNotification('Break started', 'info');
                    } else {
                        breakBtn.innerHTML = '<i class="fas fa-pause"></i> Break';
                        statusElement.innerHTML = '<i class="fas fa-circle"></i> On Shift';
                        statusElement.className = 'badge badge-success';
                        showNotification('Break ended', 'info');
                    }
                }
            } catch (error) {
                console.error('Handle break toggle error:', error);
                showNotification('Break operation failed', 'error');
            }
        }

        function exportAttendance() {
            try {
                if (window.attendanceManager && typeof window.attendanceManager.exportAttendanceData === 'function') {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    window.attendanceManager.exportAttendanceData(startDate, endDate);
                } else {
                    showNotification('Export functionality coming soon', 'info');
                }
            } catch (error) {
                console.error('Export attendance error:', error);
                showNotification('Export failed', 'error');
            }
        }

        function generateAttendanceReport() {
            try {
                if (window.attendanceManager && typeof window.attendanceManager.generateAttendanceReport === 'function') {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    window.attendanceManager.generateAttendanceReport(startDate, endDate).then(report => {
                        displayAttendanceReport(report);
                    });
                } else {
                    showNotification('Report generation coming soon', 'info');
                }
            } catch (error) {
                console.error('Generate attendance report error:', error);
                showNotification('Report generation failed', 'error');
            }
        }

        function displayAttendanceReport(report) {
            try {
                const modal = document.getElementById('attendanceReportModal');
                const content = document.getElementById('attendanceReportContent');
                
                if (modal && content && report) {
                    content.innerHTML = `
                        <div class="report-summary">
                            <h4>Attendance Summary</h4>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <strong>Period:</strong> ${report.period}
                                </div>
                                <div class="summary-item">
                                    <strong>Total Days:</strong> ${report.totalDays}
                                </div>
                                <div class="summary-item">
                                    <strong>Present Days:</strong> ${report.presentDays}
                                </div>
                                <div class="summary-item">
                                    <strong>Attendance Rate:</strong> ${report.attendanceRate}%
                                </div>
                                <div class="summary-item">
                                    <strong>Total Hours:</strong> ${report.totalHours}h
                                </div>
                                <div class="summary-item">
                                    <strong>Average Hours:</strong> ${report.averageHours}h
                                </div>
                            </div>
                        </div>
                    `;
                    
                    modal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Display attendance report error:', error);
            }
        }

        function exportReport() {
            try {
                showNotification('Report export functionality coming soon', 'info');
            } catch (error) {
                console.error('Export report error:', error);
            }
        }

        // Navigation functions
        function toggleSidebar() {
            try {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('collapsed');
                }
            } catch (error) {
                console.error('Toggle sidebar error:', error);
            }
        }

        function toggleUserMenu() {
            try {
                const dropdown = document.getElementById('userMenuDropdown');
                const button = document.querySelector('.user-avatar');
                
                if (dropdown) {
                    const isVisible = dropdown.style.display !== 'none';
                    dropdown.style.display = isVisible ? 'none' : 'block';
                    
                    if (button) {
                        button.setAttribute('aria-expanded', !isVisible);
                    }
                }
            } catch (error) {
                console.error('Toggle user menu error:', error);
            }
        }

        function showProfile() {
            showNotification('Profile management feature coming soon', 'info');
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            } catch (error) {
                console.error('Close modal error:', error);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            try {
                const userMenu = document.getElementById('userMenuDropdown');
                const userButton = document.querySelector('.user-avatar');
                
                if (userMenu && userButton && 
                    !userButton.contains(event.target) && 
                    !userMenu.contains(event.target)) {
                    userMenu.style.display = 'none';
                    userButton.setAttribute('aria-expanded', 'false');
                }
            } catch (error) {
                console.error('Click outside handler error:', error);
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            try {
                if (event.key === 'Escape') {
                    // Close any open modals or dropdowns
                    const modals = document.querySelectorAll('.modal-overlay');
                    modals.forEach(modal => {
                        modal.style.display = 'none';
                    });
                    
                    const userMenu = document.getElementById('userMenuDropdown');
                    if (userMenu) {
                        userMenu.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Keyboard navigation error:', error);
            }
        });
    </script>
</body>
</html>
